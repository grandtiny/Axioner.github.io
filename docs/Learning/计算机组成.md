# 计算机组成

## 1 计算机概述

### 1.1 计算机发展历程

*   1946第一台电子数字计算机
*   电子管计算机-晶体管计算机-中小规模集成电路时代-超大规模集成电路时代
*   微型计算机的发展以微处理器技术为标志

### 1.2 计算机系统层次结构

*   软硬件逻辑功能等价
*   计算机功能部件：输入输出设备、存储器、运算器、控制器
*   运算器：累加器ACC、乘商寄存器MQ、操作数寄存器X、变址寄存器IX、基址寄存器BR、程序状态寄存器（标志寄存器）PSW
*   控制器：程序计数器PC、指令寄存器IR、控制单元CU
*   IR内容来自MDR、操作码OP（IR）送至CU、Ad（IR）送至MAR
*   **指令执行的流程**：将程序的第一条指令的地址从主存送入PC，PC内容送至MAR，MAR根据内容从存储中读出指令送至MDR，MDR将指令送入IR，IR将操作数地址码Ad（IR）送至MAR、操作码OP（IR）送至CU，MAR根据内容从存储中读出另一个操作数送至MDR，MDR将内容送至ACC。
*   系统软件、应用软件
*   机器语言、汇编语言、高级语言
*   汇编器、解释器、编译器
*   微程序机器层-传统机器语言层-操作系统层-汇编语言层-高级语言层
*   指令集体系结构ISA
*   源程序hello.c（预处理器cpp）-源程序hello.i（编译器ccl）-汇编程序hello.s（汇编器as）-目标程序hello.o（链接器ld）-可执行文件hello
*   地址译码器在主存里，地址寄存器在CPU里
*   相联存储器能按内容寻址也能按地址寻址
*   存储程序原理就是将指令以代码的形式事先输入计算机主存储器

### 1.3 计算机的性能指标

*   机器字长、指令字长、存储字长：指令字长是一个指令字中包含的二进制代码位数；存储字长是一个存储单元中存储的二进制代码的长度。
*   数据通路带宽（外部数据总线宽度）
*   主存容量：64K x 32位=MAR16（2^16^）位，MDR32位
*   运算速度：吞吐量、响应时间、主频、CPU时钟周期、执行一条指令所需时钟周期数CPI（Cycle Per Instruction）、CPU执行时间、MIPS（Million Instructions Per Second）、MFLOPS（Million Floating-point Operations Per Second）、
*   存储容量大写K，速度频率小写k
*   基准程序
*   系列机、兼容、软件可移植性、固件
*   翻译程序包括汇编程序和编译程序，汇编程序是特殊化的编译程序，他将汇编语言翻译为机器语言
*   在CPU中，IR、MAR、MDR对各路程序员都是透明的，指令寄存器对用户完全透明
*   寄存器间位数的关系：2^m^xN位代表地址总线宽度为m位，数据总线宽度为N位，因此MAR和PC为m位，MDR为N位；IR、ACC、MQ、X等运算寄存器看存储字长

## 2.数据的表示和运算

### 2.1 数制与编码

*   计算机中，小数是离散的，并不是每个十进制的小数都可以用二进制准确的表述
*   移码1正0负，其他0正1负
*   正数补码就是原码
*   BCD码：8421码、余3码、2421码；都是用4个二进制表示十进制中的0-9。
*   移码中的0表示唯一
*   原码和反码在数轴上对称，都有+0和-0
*   无符号整数默认整数，n位带符号整数表示范围为-2^n-1^~2^n-1^-1
*   纯小数原码定义：正数表达为x，负数表达为1-x。
*   小数的表示范围：原码：-(1-2^-n^)到1-2^-n^；补码：-1到1-2^-n^；
*   整数的表示范围：原码：-(2^n^-1)到2^n^-1；补码：-2^n^到2^n^-1
*   原码整数有正零和负零；小数补码比原码多一个“-1”，整数补码比原码多一个“-2^n^”

### 2.2 运算方法和运算电路

*   一位全加器、串行进位加法器、并行进位加法器、带标志加法器
*   OF溢出、ZF零、进位/借位CF、和符号SF
*   负数补码的扩展附加位整数用1小数用0
*   数据大端存储和小端存储，按边对齐，大端就是从低到高
*   **移位运算**：正数补码反码原码左右都补0，负数原码左右都补0、补码左补0右补1、反码左右都补1。
*   **定点数补码加减运算**：加则两补码相加，减则加其中一个的负数补码。
*   **定点数原码加减运算**：符号位相同直接加，不同则绝对值大的减小的，符号位取大的。
*   **定点数原码乘法运算**：符号位由两个乘数的符号位异或得出，部分积最开始赋值为零；乘法从一个乘数的最低为开始，若为1则部分积加上另一个乘数的绝对值，否则加零；如此比较到乘数全部移除时得出结果
*   无符号数乘法电路：算法理论同上，但用来处理无符号数
*   **定点数补码一位乘法**：也称Booth算法，符号位参与运算，一般采取双符号位；首先在乘数末尾添加一个初值为零的附加位，部分积初值为零；从乘数的附加位及其左边一位开始比较，“01”则加另一个乘数的补码，“10”则加另一个乘数的负数补码，直至乘数比较完。
*   符号扩展：负数补码扩展时整数都添加1小数都添加0
*   **定点数原码除法运算**：也称不恢复余数法，符号位异或得；先用被除数减去除数，余数为正商上1，余数和商左移一位接着减除数；余数为负商上0，余数和商左移一位接着加上除数；当n+1步余数为负时需要加上除数的绝对值得到正确的余数。
*   **定点数补码除法运算**：也称加减交替法，符号位参与运算；开始时同号则被除数减去除数，异号则加上；此时余数与除数同号则商上1且余数左移一位减去除数，异号商上0且余数左移一位加上除数；精度无特殊要求时一般采用末位置1。
*   C语言中的类型位数：char/unsigned char 8位，short int 16位，int/unsigned int 32位，float 32位，double 64位，long int 64位

### 2.3 浮点数的表示与运算

*   浮点数的尾数用定点原码小数表示，阶码用移码表示；表示范围为|2^-24^x2^-24^~(1-2^-24^)x2^63^|
*   浮点数规格化：小数后先出现0则左规，每左移一次阶码减1；右规同
*   IEEE标准：短浮点数1-8-23位，偏置值为127，最小2^-126^，最大2^127^x(2-2^-23^)；长浮点数1-11-52位，偏置值为1023，最小2^-1022^，最大2^1023^x(2-2^-52^)。全0时为正负0，全1时为正负无穷大；第一位符号位为(-1)^S^，即正0负1
*   **浮点数的加减运算**：对阶以小阶向大阶看齐为原则，尾数运算完后需要再规格化一次，最后舍入（四舍五入，恒置1，截断）并判断溢出（上溢报异常下溢置0）
*   尾数为补码时，1.0xxx时为规格化数；原码时正数0.1xxx，负数1.1xxx

## 3 存储系统

### 3.1 存储器概述

*   存储器的分类可以按在计算机中的作用分类、按存储介质分类、按存取方式分类、按信息的可保存性分类
    *   作用分类：主存储器、辅助存储器、高速缓冲存储器
    *   介质分类：磁表面存储器（磁盘磁带）、磁芯存储器、半导体存储器（MOS、双极型）、光存储器（光盘）
    *   存取方式分类：随机存储器、只读存储器、串行访问存储器
*   串行访问存储器需要按照物理位置的先后顺序寻址，包括顺序存取存储器（磁带）和直接存取存储器（磁盘、光盘）
*   存储容量=存储字长*字长
*   每位价格=总成本/总容量
*   数据传输率=数据的宽度/存储周期
*   主存和Cache之间调动对所有程序员透明，主存和辅存调动对应用程序员透明
*   外存-辅存-内存-cache-寄存器-cpu
*   磁盘属于直接存储寄存器（DAM）

### 3.2 主存储器

*   存储元（最基本，一个二进制位）-存储单元-存储体
*   SRAM的存储元是双稳态触发器（六晶体管MOS）、DRAM是电容
*   SRAM特点：非破坏性、不用刷新、同时送行列地址、运行速度高、集成度低、存储成本高
*   DRAM特点：破坏性、要刷新、分两次送地址、运行速度慢、集成度高、存储成本低
*   存储器芯片由存储体、IO读写电路、地址译码和控制电路等组成
*   DRAM的刷新：集中刷新、分散刷新、异步刷新
*   DRAM的刷新对CPU是透明的，即刷新不依赖于外部
*   掩模式只读存储器（MROM）、一次可编程只读存储器（PROM）、可擦除可编程只读存储器（EPROM）
*   SRAM的行列地址是同时送完，DRAM的行列地址是分两次送，所以地址线减半
*   单体多字存储器、多体并行存储器（高位交叉（模块内连续）、低位交叉（相邻模块连续））
*   计算芯片引脚数目时除了数据线和地址线还需考虑片选线、读写控制线（可能还有接地线和电源），当采用地址线复用时还需考虑行通选线和列通选线
*   读取数据的周期数需要考虑数据的起始位置在交叉编址的存储器中的第几个

### 3.3 主存储器与CPU的连接

*   位扩展（在没有利用满数据总线时扩展）：CPU传输过来的地址总线对每一个存储都一样，传回去的地址总线各自占据不同位置
*   字扩展（在没有利用满地址总线时扩展）：多余的字可以选定不同的数据片工作，多n个字可以选择2^n^个数据片。
*   片选时有线选法（每条线只匹配一条线）和译码片选法（二进制编码）

### 3.4 外部存储器

*   磁盘存储器-磁盘驱动器、磁盘控制器、盘片
*   存储区域：磁头、记录面-磁道-扇区
*   磁记录方式：调频制（FM）、改进型调频制（MFM）
*   磁盘的性能指标：记录密度、容量、平均存取时间、数据传输率
*   磁盘容量和存取时间和传输速度的计算
*   磁盘地址的一般形式：驱动器号-柱面（磁道）号-盘面号-扇区
*   磁盘阵列RAID（独立冗余磁盘阵列）：多个独立物理盘组成一个独立逻辑盘
*   RAID0-无冗余和无校检的磁盘阵列
*   RAID1-镜像磁盘阵列
*   RAID2-采用纠错的海明码阵列
*   RAID3-位交叉奇偶校验的磁盘阵列
*   RAID4-块交叉奇偶校验的磁盘阵列
*   RAID5-无独立校验的奇偶校验磁盘阵列
*   存取时间=寻道时间+延迟时间+传输时间
*   存取一个扇区的平均延迟时间为旋转半周的时间

### 3.5 高速缓冲存储器

*   程序访问的局部性原理：空间局部性-将要使用的信息和正在使用的信息在存储空间上时临近的、时间局部性-将要使用的信息可能正在使用的信息
*   Cache的三种地址映射：直接映射、全相联映射、组相联映射
*   Cache中贮存块的替换算法：随机（RAND）算法、先进先出（FIFO）算法、近期最少使用（LRU）算法、最不经常使用（LFU）算法
*   Cache写算法：全写法（write-through）-写命中时同时写cache和主存，为了降低时间损耗会在cache和主存中间加一个write buffer，写缓冲是一个FIFO队列，频繁写会导致写缓冲饱和溢出。回写法（write-back）-平时只写cache，需要替换该内存块时才会写回主存，为了减少写回主存的开销，会设置一个二进制脏位判断是否修改过。
*   与局部性原理有关的是近期最少使用法LRU

### 3.6 虚拟存储器

*   虚拟存储器对应用程序员来说是透明的，Cache则对所有程序员透明
*   访存操作流程：CPU给出虚拟地址，虚拟地址的对应表象有在快表（TLB）中时就将虚拟地址转化为物理地址，否则访问主存中的页表，如果页表存在就访问并根据替换原则将该表更新到TLB中，不存在则从磁盘中读出一页到主存，再更新页表和TLB；根据物理地址访问的对应主存块在Cache时则直接存取数据，不存在时根据替换原则从主存中访问并更新Cache。

### 3.7 本章小结

*   存储器的层次结构主要体现在Cache-主存、主存-辅存这两个存储层次上。
*   取指令Cache缺失时，PC先恢复当前指令的值，然后对主存进行读操作，将读到的指令放入Cache并更新，重新执行

## 4 指令系统

### 4.1 指令系统

*   指令集体系结构（ISA）

*   指令-操作码-地址码-指令长度-单字长指令-半字长指令-双字长指令-定长指令字结构-变长指令字结构
*   零地址指令：只有操作码，运用于不需要操作数的指令和堆栈计算机
*   一地址指令-二地址指令-三地址指令-四地址指令
*   扩展操作码指令格式，最后一位留给低位地址指令
*   指令操作类型：数据传送、算数和逻辑运算、移位、转移、输入输出
*   中断隐指令由硬件实现
*   单地址指令的两个操作数的算术运算中，一个操作数由地址码指出，另外一个在累加器中
*   寻址单元数的计算，编码位数的计算，扩展地址指令数的计算

### 4.2 指令的寻址方式

*   形式地址（A）、有效地址（EA）；带括号的时候表示指向到该地址的数据中
*   指令寻址-顺序寻址-跳跃寻址；数据寻址：指令字中多一段寻址特征
*   隐含寻址：隐含给出操作数地址，访存0次
*   立即数寻址：地址位为操作数，访存0次
*   直接寻址：形式地址即为操作数真实地址，访存1次
*   间接寻址：直接寻址的间接方式，可以多次间接，访存1+n次（一般问到扩大寻址范围都是指寄存器间接寻址）
*   寄存器寻址：地址位为寄存器的编码，访存0次
*   寄存器间接寻址：真实地址在寄存器里，访存n次
*   相对寻址：形式地址加上PC的值形成真实地址，访存1次
*   基址寻址：基址寄存器加上相对地址，访存1次
*   变址寻址：变址寄存器加上相对地址，访存1次
*   堆栈寻址
*   采用不同寻址方式的目的是为了缩短指令字长，扩大寻址空间，提高编程的灵活性，但这也提高了指令译码的复杂度。
*   程序控制是靠转移指令而非寻址方式实现
*   寻址方式使用情况
    *   立即寻址操作数获取简单，常用于给寄存器赋初值
    *   基址寻址扩大了操作数寻址范围，适合多道程序，常用于为程序或数据分配存储空间
    *   变址寻址适合编制循环程序
    *   相对寻址适用于控制程序的执行顺序、转移等

### 4.3 程序的机器级代码表示

*   mov复制：不能直接内存复制到内存
*   pop/push出栈入栈：ESP是栈顶，栈增长方向与内存增长方向相反，入栈时ESP-4
*   add/sub：两个操作数相加减，结果保存在第一个操作数
*   inc/dec自加自减1
*   imul：带符号整数乘法，两种格式，第一种为两个操作数相乘后结果保存在第一个操作数中，第一个操作数必须为寄存器；第二种为三个操作数，将第二个和第三个相乘后结果放在第一个操作数中，第一个必须为寄存器。
*   idiv：带符号整数出发指令，只有一个操作数即除数，被除数为edx：eax中的内容（64位整数）操作结果的商送到eax，余数送到edx
*   and/or/xor与或异或
*   not位（0，1）翻转
*   neg取负
*   shl/shr逻辑左右移：第一个操作数为被操作数，第二个操作数为移位位数
*   jmp跳转、cmp/test比较和逐位与（都不保存运算结果）、call/ret调用返回
*   EAX、ECX、EDX是调用者保存寄存器；EBX、ESI、EDI是被调用者保存寄存器
*   CF有借位1无借位0、ZF结果零1不零0、SF负号1其他0、OF溢出1否则0
*   帧指针寄存器EBP指向栈帧的起始位置（栈底），帧指针寄存器ESP指向栈顶
*   过程调用的机器级表示：当调用一个进程时本身信息先保存，新的ebp和esp指向被调用进程占用的空间，此时原栈帧中栈顶有部分字节留空给返回值用，在调用过程中产生需要返回的值便由指令直接返回新栈帧的栈底-4*n（即原栈帧的栈顶）
*   数据运算中标志符虽然结果对运算结果无意义，但依旧会变动
*   add指令的操作数通常是带符号补码

### 4.4 CISC和RISC的基本概念

*   CISC：复杂指令系统计算机，不固定指令字长、不限制可访存指令、指令执行完成时间相差较大
*   RISC：精简指令系统计算机
*   RISC优势：更能充分利用芯片面积；更高的运行速度；便于设计；有利于编译程序代码优化
*   RISC一定使用流水线，指令长度固定，访存指令有限制

## 5 中央处理器

### 5.1 CPU的功能和基本结构

*   具体功能包括：指令控制、操作控制、时间控制、数据加工、中断处理
*   控制器负责指令，运算器负责数据加工
*   运算器有：算术逻辑单元ALU、暂存寄存器、累加寄存器ACC、通用寄存器组、程序状态字寄存器PSW、移位器、计数器CT
*   暂存寄存器对应用程序员透明
*   控制器有：程序计数器PC、指令寄存器IR、指令译码器、存储器地址寄存器MAR、存储器数据寄存器MDR、时序系统、微操作信号发生器（其结构有组合逻辑型和存储逻辑型）
*   用户可见寄存器：通用寄存器组、程序状态字寄存器等
*   用户透明寄存器：存储器地址寄存器、存储器数据寄存器、指令寄存器等
*   程序计数器的位数取决于存储器的容量
*   指令译码是指对指令的操作码部分进行译码
*   地址译码器是主存等存储器的组成部分
*   CPU专用寄存器有PC、IR、MDR、MAR、PSW

### 5.2 指令执行过程

*   取址周期访存为了取指令、间址周期访存为了取有效地址、执行周期为了取操作数、中断周期为了保存程序断点
*   无条件转移指令执行时不访问主存，所以只有取址周期和执行周期
*   标志触发器：FE取址、IND间址、EX执行、INT中断
*   取指周期流程：将存放在PC的指令地址送到MAR再送到地址总线再送到主存；此时CU发出读命令给控制总线再送到主存；主存接受到数据后将读到的**指令代码**送回数据总线再送回MDR，最后送回IR；最后CU发送信号给PC让PC+1结束。（PC->IR）
*   间址周期流程：指令中的地址码从IR或者MDR送到MAR再送到地址总线再到主存；此时CU发出读命令给控制总线再送到主存；主存接受到数据后将读到的**有效地址**送回数据总线再送回MDR。
*   中断周期流程：CU将**SP减1的信息**传到MAR到地址总线再到主存，同时发出写命令到控制总线再到主存中；PC的指令地址信息传到MDR到数据总线再到主存，将程序断点存入堆栈中；最后CU将中断服务程序的入口地址传给PC。
*   单指令周期-多指令周期-流水线方案
*   存取周期是指存储器进行两次独立的存储器操作（读写）所需的最小间隔时间
*   指令周期指取出一条指令加上执行这条指令的时间

### 5.3 数据通路的功能和基本结构

*   CPU内部单总线方式、CPU内部多总线方式、专用数据通路方式
*   寄存器之间的数据传送：依靠CPU内部总线
*   主存与CPU之间的数据传送：需要借助CPU内部总线
*   执行算术或逻辑运算
*   单周期处理器是指所有指令的指令周期为一个时钟周期的处理器，即每条指令的CPI都为1
*   取址阶段的PC访问完内存马上就加1，不是最后指令周期结束了才加1

### 5.4 控制器的功能和工作原理

*   控制器的主要功能
    *   取出指令并指出下一条指令在主存中位置
    *   指令译码或测试，产生对应控制信号启动对应操作
    *   指挥控制数据流
*   硬布线控制器
    *   控制单元CU输入信号来源：操作码译码电路ID、节拍发生器、状态标志；同时还接收系统总线的控制信号例如中断请求、DMA请求
    *   CPU控制方式：同步控制方式-异步控制方式-联合控制方式
    *   单元设计：列出微操作命令的操作时间表
*   微程序控制器-微命令与微操作-微指令与微周期-微地址寄存器与微指令寄存器
*   主存储器用于存放程序和数据，在CPU外部，用RAM实现；控制存储器用于存放微程序，在CPU内部，用ROM实现
*   微指令的编码方式：直接编码（n个微指令n位）、字段直接编码（2的位数）字段间接编码
*   水平型微指令-垂直型微指令-混合型微指令

### 5.5 异常和中断机制

*   异常分类：故障、自陷、终止；通常由CPU内部产生
*   CPU响应过程：关中断、保存断点和程序状态、识别异常和中断并转到相应的处理程序

### 5.6 指令流水线

*   时间并行-空间并行

*   取指（IF）-译码/读寄存器（ID）-执行/计算地址（EX）-访存（MEM）-写回（WB）

*   流水寄存器保存流水线暂存结果

*   结构冒险：资源冲突；解决方法：后一条指令暂停一个周期；单独设置数据存储器和指令存储器

*   数据冒险：数据脏读（写后读，读后写，写后写）；解决方法：后续指令暂停相应周期；设置相关专用通路；通过编译器优化

*   控制冒险：执行转移；解决方法：对转移指令进行分支预测；预取转移两个分支流上的指令；加快提前形成条件码；提高转移方向的猜准率。

*   性能指标：吞吐率、加速比

*   超标量流水线技术是同一时间周期发出多条独立指令，超长指令字技术是将指令合成一条长指令，超流水线技术是提高流水线主频的技术

*   空间并行指资源重复，时间并行指时间重叠

*   k段流水线完成n个任务的时间为(k+n-1)t

### 5.7 多处理器的概念

*   单指令流单数据流SISD
*   单指令流多数据流SIMD
*   多指令流单数据流MISD
*   多指令流多数据流MIMD
*   硬件多线程：细粒度多线程、粗粒度多线程、同时多线程
*   多核处理器、共享内存多处理器

## 6 总线

### 6.1 总线概述

*   总线：分时（同一时间只允许一个）；共享（多个设备）
*   主设备从设备
*   总线特性：机械特性、电气特性、功能特性、时间特性
*   总线分类：片内总线、系统总线、IO总线、通信总线
*   结构：单总线结构、双总线结构、三总线结构
*   总线标准：ISA、EISA、VESA、PCI。。。
*   性能指标：总线传输周期、总线时钟周期、总线工作频率、总线宽度、总线带宽、总线复用、信号线数

### 6.2 总线事务和定时

*   事务：请求阶段-仲裁阶段-寻址阶段-传输阶段-释放阶段
*   突发（猝发）传送方式能够进行连续成组数据的传送，其寻址阶段发送的是连续数据单元的首地址，等所有数据发送完后再释放总线
*   同步定时方式、异步定时方式（不互锁方式、半互锁方式、全互锁方式）

## 7.输入/输出系统

### 7.1 IO系统基本概念

*   外部设备、接口、输入设备、输出设备、外存设备、IO软件、IO硬件
*   程序查询方式、程序中断方式、DMA方式、通道方式
*   输入设备：键盘、鼠标
*   输出设备：显示器、打印机
*   外部存储器：磁表面存储器、固态硬盘、光盘存储器
*   显示器刷新带宽=分辨率x颜色位数x帧数

### 7.2 IO接口

*   IO接口功能：地址译码和设备选择、主机和外设通信联络控制、数据缓冲、信号格式转换、传送控制命令和状态信息
*   端口是接口电路种可以进行读写的寄存器，若干端口加上相应的控制逻辑才可以组成接口
*   数据传送方式分类：并行接口（一个字）、串行接口（一位）
*   控制方式分类：程序查询接口、程序中断接口、DMA接口
*   灵活性分类：可编程接口、不可编程接口
*   端口统一编址，又称存储器映射方式，把IO端口当作存储单元编址，不需要专门的IO指令；内存容量变小，执行速度慢
*   端口独立编址，又称IO映射方式

### 7.3 IO方式

*   程序查询方式：CPU一旦启动IO就必须停止现行程序的运行，有踏步等待现象，效率低
*   程序中断方式：可以并行，软中断执行的方式
*   INTR线是可屏蔽中断，NMI线是不可屏蔽中断
*   中断优先级分响应优先级和处理优先级，响应优先级在硬件上固定不便更改，处理优先级可以动态调整实现多重中断
*   中断向量：非向量中断即软件查询法，向量中断中的每个中断都有一个唯一的类型号，通过识别类型号选择进入什么中断程序就是向量中断法
*   DMA控制器与CPU的三种使用主存方式：有DMA时停止主存访存；周期挪用；交替访存
*   DMA的数据传送过程：预处理、数据传送、后处理
*   用户程序需要输入输出时引起的中断是访管中断
*   中断隐指令不在指令系统内，因此不属于程序控制指令
*   
